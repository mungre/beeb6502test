100LOMEM=TOP+20
200PROCversion
250IFA%=1THENPROCrestart
300B%=1
400T%=7
450*FX4,1
500MODE7
550VDU 23,1,0;0;0;0;
600VDU31,0,T%-3
610PRINT "    CPU Tests"
620PRINT'
700PRINT"    1 BBC Model B (6502)"
800PRINT"    2 BBC Master (65C02)"
900PRINT"    3 Tube (65C02)"
1030PRINT
1100PRINT"    4 No BCD test"
1200PRINT"    5 Basic BCD test"
1300PRINT"    6 Full BCD test"
1400PRINT'
1500PRINT"    Press RETURN to run the tests"
1600PROChi(S%)
1700PROChi(B%+4)
1705REPEAT
1710K%=GET
1715IF49<=K%ANDK%<=51THENPROCun(S%):S%=K%-49:PROChi(S%)
1717IF52<=K%ANDK%<=54THENPROCun(B%+4):B%=K%-52:PROChi(B%+4)
1718UNTILK%=13
1719C%=S%>0
1720CLS
1721IFB%<>0THENPROCbcd
1225IFS%=0THENO%=0ELSEO%=1
1730PROCstandard
1800END
1900DEFPROCversion
2000P%=TOP
2100[
2200OPT 0
2300LDA #0
2400LDX #1
2500JSR &FFF4
2600STX &70
2700LDA #234
2800LDX #0
2900LDY #255
3000JSR &FFF4
3100STX &71
3200RTS
3300]
3400CALLTOP
3500IF?&71<>0THENS%=2ELSEIF?&70=3THENS%=1ELSES%=0
3600ENDPROC
3700DEFPROChi(Y%)
3800VDU31,0,Y%+T%,129,157,135
3900ENDPROC
4000DEFPROCun(Y%)
4100VDU31,1,Y%+T%,32
4200ENDPROC
4300DEFPROCbcd
4350PRINT"== BCD test =="'
4400f$="BCD_"
4500IFB%=1THENf$=f$+"B"ELSEf$=f$+"F"
4600IFC%THENf$=f$+"C"
4650PRINT "Started test " + f$ + "... ";
4660OSCLI "RUN +." + f$
4670IF?&70=0PRINT"succeeded"ELSEPRINT"failed"
4800ENDPROC
5000DEFPROCrestart
5050A%=0
5100VDU6
5130IFO%=1THENPROCextended
5140PRINT
5150VDU 23,1,1;0;0;0;
5200END
5300ENDPROC
5400DEFPROCstandard
5500PRINT'"== 6502 opcode test =="
5700*RUN "+.TEST1"
5800END
5900ENDPROC
6000DEFPROCextended
5500PRINT'"== 65C02 opcode test =="
5600O%=0
5700*RUN "+.TEST2"
5800END
5900ENDPROC
