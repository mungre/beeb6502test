100LOMEM=TOP+&300
150IFA%=1THENPROCrestart
200PROCversion
300B%=1
400L%=9
450*FX4,1
500MODE7
550VDU 23,1,0;0;0;0;
600VDU31,0,L%-6
610PRINT "    CPU Tests"''
630IFS%=0THENc$="6502"ELSEIFS%=1THENc$="65SC02"ELSEc$="65C02"
640PRINT"    ";c$;
650IFT%<>0PRINT" second processor";
660PRINT" detected"''
700PRINT"    1 6502   (BBC Model B)"
800PRINT"    2 65SC02 (BBC Master or 2nd Proc)"
900PRINT"    3 65C02  (2nd Proc)"
1030PRINT
1100PRINT"    4 No BCD test"
1200PRINT"    5 Basic BCD test"
1300PRINT"    6 Full BCD test"
1400PRINT'
1500PRINT"    Press RETURN to run the tests"''
1600PROChi(S%)
1700PROChi(B%+4)
1705REPEAT
1710K%=GET
1715IF49<=K%ANDK%<=51THENPROCun(S%):S%=K%-49:PROChi(S%)
1717IF52<=K%ANDK%<=54THENPROCun(B%+4):B%=K%-52:PROChi(B%+4)
1718UNTILK%=13
1719C%=S%>0
1720CLS
1721IFB%<>0THENPROCbcd
1730PROCstandard
1800END
1900DEFPROCversion
2000Q%=(255+TOP)AND&FF00
2050FORR%=0TO2STEP2
2060P%=Q%
2070[OPTR%
2075EQUB cpu6502 DIV 256
2080.cpu65C02
2090LDA #0
2100STA &70
2110CLV
2120EQUB &87:EQUB &70:NOP ; SMB0 &70,NOP or NOP,BVS x
2150SEC
2160ADC &70 ; 0 or 1
2170STA &44C
2180RTS
2190.version
2310LDA #234
2320LDX #0
2330LDY #255
2340JSR &FFF4
2350STX &450
2400JMP (ind)
2860]
2870P%=P%OR255
2880[OPTR%
2885.ind
2890EQUB cpu6502 MOD 256
2900EQUB cpu65C02 DIV 256
2910.cpu6502
2920LDA #0
2930STA &44C
2940RTS
3300]
3350NEXT
3400S%=0
3450T%=0
3500CALLversion
3600ENDPROC
3700DEFPROChi(Y%)
3800VDU31,0,Y%+L%,129,157,135
3900ENDPROC
4000DEFPROCun(Y%)
4100VDU31,1,Y%+L%,32
4200ENDPROC
4300DEFPROCbcd
4350PRINT"== BCD test =="'
4400f$="BCD_"
4500IFB%=1THENf$=f$+"B"ELSEf$=f$+"F"
4600IFC%THENf$=f$+"C"
4650PRINT "Started test " + f$ + "... ";
4660OSCLI "RUN +." + f$
4670IF?&70=0PRINT"succeeded"ELSEPRINT"failed"
4800ENDPROC
5000DEFPROCrestart
5050A%=0
5100VDU6
5130IFS%<>0THENPROCextended
5140PRINT
5150VDU 23,1,1;0;0;0;
5200END
5300ENDPROC
5400DEFPROCstandard
5500PRINT'"== 6502 opcode test =="
5700*RUN "+.6502"
5800END
5900ENDPROC
6000DEFPROCextended
6050IFS%=1THENf$="65SC02"ELSEf$="65C02"
6500PRINT'"== ";f$;" opcode test =="
6600S%=0
6700OSCLI "RUN +." + f$
6800END
6900ENDPROC
